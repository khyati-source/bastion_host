Access bastion via EC2 Connect â†’ generate key â†’ copy key to your local machine â†’ use it to SSH from local terminal.

âœ… Full Step-by-Step: Use SSH from CLI for Bastion EC2
ğŸŸ¢ Step 1: Connect to Bastion EC2 Using EC2 Instance Connect (Web Console)
Go to AWS Console â†’ EC2 â†’ Instances.

Select the bastion public instance.

Click Connect â†’ EC2 Instance Connect â†’ Connect.

You're now inside the instance via browser-based terminal.



ğŸŸ¢ Step 2: Generate an SSH Key Pair Inside Bastion
In the EC2 shell (via browser):
ssh-keygen -t rsa -b 2048 -f ~/.ssh/mykey
Press Enter to accept default location /home/ec2-user/.ssh/mykey.

Skip passphrase (just press Enter).

This generates:

Private key: ~/.ssh/mykey

Public key: ~/.ssh/mykey.pub



ğŸŸ¢ Step 3: Add Public Key to authorized_keys
cat ~/.ssh/mykey.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
This lets anyone with mykey private key SSH into the instance.



ğŸŸ¢ Step 4: Copy the Private Key to Your Local Machine
Now, get the content of the private key so you can use it from your local terminal:
cat ~/.ssh/mykey

Copy the entire output (starts with -----BEGIN RSA PRIVATE KEY----- and ends with -----END RSA PRIVATE KEY-----).


.

ğŸŸ¢ Step 5: On Your Local System, Create a Private Key File
On your local PC, open a terminal and run:
nano ~/.ssh/my-bastion-key
Paste the private key you copied into this file.
Then:
chmod 400 ~/.ssh/my-bastion-key



ğŸŸ¢ Step 6: SSH into Bastion from Your CLI
Now use the following command:
ssh -i ~/.ssh/my-bastion-key ec2-user@<Public-IP-of-Bastion>
Replace <Public-IP-of-Bastion> with your EC2 instanceâ€™s public IP (youâ€™ll find this in the EC2 Console).


âœ… Summary of File Roles
| File              | Location      | Purpose                    |
| ----------------- | ------------- | -------------------------- |
| `mykey`           | Bastion EC2   | Private key (temp)         |
| `mykey.pub`       | Bastion EC2   | Public key                 |
| `authorized_keys` | Bastion EC2   | Allows your key to connect |
| `my-bastion-key`  | Local machine | Used by you to SSH         |





===============================================================================================================================================


âœ… Goal:
Connect from your bastion EC2 to a private EC2 instance via SSH



ğŸ”§ Pre-Checks Before You Connect
âœ… 1. Instances are in the same VPC
Bastion (public) and Private EC2 are in same VPC, in different subnets (public and private).

âœ… 2. Security Group of Private EC2 allows SSH
Private EC2â€™s Security Group must allow:

Port 22 (SSH) from either:

The bastionâ€™s private IP (e.g., 10.0.1.20), or

The bastionâ€™s Security Group (recommended way).

Example Inbound Rule (Private Instance SG):
| Type | Protocol | Port | Source                     |
| ---- | -------- | ---- | -------------------------- |
| SSH  | TCP      | 22   | Bastion's SG (sg-xxxxxxxx) |



âœ… 3. You have an SSH key to access the private instance
You must either:

Already have a .pem or private key file on the bastion to access the private instance, OR

Add a new public key to the private instanceâ€™s ~/.ssh/authorized_keys.


ğŸ› ï¸ Option A: If You Already Have Private Instance's Key
Letâ€™s say you have private-key.pem file already on the bastion.

ğŸŸ¢ Step 1: Make the Key File Secure
chmod 400 private-key.pem
ğŸŸ¢ Step 2: SSH into Private Instance
ssh -i private-key.pem ec2-user@<Private-IP>
Example:
ssh -i private-key.pem ec2-user@10.0.2.12
Use ec2-user for Amazon Linux 2, or ubuntu for Ubuntu AMIs.

Replace with actual private IP of the private instance (from EC2 Console).


ğŸ› ï¸ Option B: If You Want to Use a Key You Just Generated on Bastion
ğŸŸ¢ Step 1: On Bastion, Copy Your Public Key
cat ~/.ssh/mykey.pub
ğŸŸ¢ Step 2: Paste That into Private EC2's ~/.ssh/authorized_keys
If you can access private EC2 via another way (SSM, key, userdata), paste this key into:
~/.ssh/authorized_keys
Or use echo:
echo "ssh-rsa AAAAB3..." >> ~/.ssh/authorized_keys
Make sure:
chmod 600 ~/.ssh/authorized_keys
ğŸŸ¢ Step 3: Connect Using the Key
ssh -i ~/.ssh/mykey ec2-user@<Private-IP>
ğŸ§± Troubleshooting?
If SSH fails:

âœ… Check security group of private EC2.

âœ… Check network ACLs.

âœ… Ensure private EC2 is running.

âœ… Check key permissions and username.



========================================================
hanks, that's clear.
âœ… You're on the bastion (public) instance,
âŒ You donâ€™t have any access (SSH or EC2 Connect) to the private instance,
âœ… You want to connect from bastion to private EC2.

ğŸ§  Important: You can only SSH into an instance if it has your public key in authorized_keys.
Since you canâ€™t access the private instance, we have 2 options:ğŸ”§ Step-by-Step
ğŸŸ¢ Step 1: Copy Your Public Key from Bastion
On the bastion, run:
cat ~/.ssh/mykey.pub
Copy the entire output â€” starts with ssh-rsa AAAA...


ğŸŸ¢ Step 2: Go to EC2 Console â†’ Private Instance
Click your private EC2 instance.

Click Actions â†’ Monitor and troubleshoot â†’ Modify user data

Choose Replace existing user data

Paste the following script:
#cloud-config
bootcmd:
  - [ mkdir, "-p", "/home/ubuntu/.ssh" ]
  - [ sh, "-c", 'echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD..." > /home/ubuntu/.ssh/authorized_keys' ]
  - [ chmod, "700", "/home/ubuntu/.ssh" ]
  - [ chmod, "600", "/home/ubuntu/.ssh/authorized_keys" ]
  - [ chown, "-R", "ubuntu:ubuntu", "/home/ubuntu/.ssh" ]

ğŸ§  What is bootcmd in cloud-init?
bootcmd is a special section in a cloud-init configuration (#cloud-config) that runs commands very early at boot time â€” before the systemâ€™s main services start.

ğŸ§¾ When to use bootcmd?
Use it when you want to:

Set up files before login

Pre-create folders

Insert SSH keys early

Configure logs or permissions

Ensure something runs on every reboot

âœ… Steps:
Go to EC2 â†’ Security Groups.

Select the Security Group of your private EC2 (sg-...).

Click Edit Inbound Rules.

Remove any existing SSH rule that uses 0.0.0.0/0.

Now click Add Rule:

Type: SSH

Protocol: TCP

Port Range: 22

Source: Custom â†’ Security Group

Select your bastionâ€™s security group (e.g., sg-0fb8cc5c9bcaaaa3e).

Save the rule âœ…

ğŸŸ¢ Step 3: Restart the Private EC2
Click Instance state â†’ Reboot instance.

After reboot, the instance will allow SSH access using the key you generated on bastion.

ğŸŸ¢ Step 4: From Bastion, SSH into Private EC2
Back on the bastion:ssh -i ~/.ssh/mykey ec2-user@<PRIVATE-IP>


